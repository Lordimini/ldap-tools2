{% extends "base.html" %}
{% block title %}Add Users to Group - LDAP Manager{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Add Users to Group</h1>
    
    <!-- Flash messages for any errors/warnings -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-messages mb-4">
                {% for category, message in messages %}
                    <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% else %}{{ category }}{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Group Search Section -->
    <form method="POST" action="{{ url_for('group.add_users_to_group') }}" class="card p-4 shadow mb-4">
        <h4 class="mb-3">Select Group</h4>
        <div class="mb-3">
            <label for="group_name" class="form-label">Search Group:</label>
            <input type="text" class="form-control" id="group_name" name="group_name" placeholder="Start typing a group name..." value="{{ prefill_group_name }}" required>
            <!-- Hidden field to store the complete DN -->
            <input type="hidden" id="group_dn" name="group_dn" value="{{ prefill_group_dn }}">
        </div>
        <button type="submit" class="btn btn-primary">Search Group</button>
    </form>

    <!-- User Search and Selection Section (only displayed if a group is selected) -->
    {% if group_info %}
    <div class="card p-4 shadow mb-4">
        <h4 class="mb-3">Group Information</h4>
        <div class="alert alert-info">
            <strong>Selected Group:</strong> {{ group_info.group_name }} <br>
            <strong>DN:</strong> {{ group_info.group_dn }}
        </div>
    </div>

    <div class="row">
        <!-- User Search -->
        <div class="col-md-6">
            <div class="card p-4 shadow mb-4">
                <h4 class="mb-3">Search Users to Add</h4>
                <form id="userSearchForm" method="POST" action="{{ url_for('group.search_users_for_group') }}" class="mb-3">
                    <input type="hidden" name="group_name" value="{{ group_info.group_name }}">
                    <input type="hidden" name="group_dn" value="{{ group_info.group_dn }}">
                    <div class="mb-3">
                        <label for="search_type" class="form-label">Search By:</label>
                        <select class="form-select" id="search_type" name="search_type" required>
                            <option value="fullName" {% if search_type == 'fullName' %}selected{% endif %}>Full Name</option>
                            <option value="cn" {% if search_type == 'cn' %}selected{% endif %}>CN (Common Name)</option>
                            <option value="workforceID" {% if search_type == 'workforceID' %}selected{% endif %}>Workforce ID</option>
                            <option value="mail" {% if search_type == 'mail' %}selected{% endif %}>Email</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="search_term" name="search_term" value="{{ search_term|default('') }}" placeholder="Enter search term..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                </form>

                {% if search_results %}
                <h5 class="mb-3">Search Results</h5>
                <div class="table-responsive">
                    <table class="table table-hover table-dark">
                        <thead>
                            <tr>
                                <th>CN</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in search_results %}
                            <tr>
                                <td>{{ user.cn }}</td>
                                <td>{{ user.fullName }}</td>
                                <td>{{ user.mail }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-success add-user-btn" 
                                            data-dn="{{ user.dn }}" 
                                            data-cn="{{ user.cn }}" 
                                            data-fullname="{{ user.fullName }}">
                                        <i class="bi bi-plus-circle"></i> Add
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Selected Users -->
        <div class="col-md-6">
            <div class="card p-4 shadow mb-4">
                <h4 class="mb-3">Selected Users</h4>
                <div id="selected_users_container" class="mb-3">
                    <div id="selected_users_list" class="list-group">
                        <!-- Selected users will be displayed here via JavaScript -->
                        <div class="text-muted" id="no_users_message">No users selected</div>
                    </div>
                </div>
                <form id="addUsersForm" method="POST" action="{{ url_for('group.confirm_add_users') }}">
                    <input type="hidden" name="group_name" value="{{ group_info.group_name }}">
                    <input type="hidden" name="group_dn" value="{{ group_info.group_dn }}">
                    <input type="hidden" id="selected_users_data" name="selected_users" value="[]">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success" id="confirm_add_btn" disabled>
                            <i class="bi bi-check-circle"></i> Confirm Add Users
                        </button>
                    </div>
                </form>
            </div>

            <!-- Current Group Members -->
            <div class="card p-4 shadow">
                <h4 class="mb-3">Current Group Members</h4>
                {% if group_info.users and group_info.users|length > 0 %}
                <div class="table-responsive">
                    <table id="currentMembersTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>CN</th>
                                <th>Full Name</th>
                                <th>Title</th>
                                <th>Service</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in group_info.users %}
                            <tr 
                                role="button" 
                                onclick="window.location.href='{{ url_for('search.search_user') }}?cn={{ user.CN | urlencode }}'" 
                                style="cursor: pointer;"
                            >
                                <td>{{ user.CN | default('N/A') }}</td>
                                <td>{{ user.fullName | default('N/A') }}</td>
                                <td>{{ user.title | default('N/A') }}</td>
                                <td>{{ user.service | default('N/A') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center">No users currently in this group.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Include DataTables CSS with extensions for better styling -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">

<!-- jQuery (required for DataTables and autocomplete) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI (for autocomplete) -->
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">

<!-- Include DataTables JS with pagination and responsive extensions -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function () {
    // Initialize DataTables for current members table
    if ($.fn.DataTable.isDataTable('#currentMembersTable')) {
        $('#currentMembersTable').DataTable().destroy();
    }
    
    $('#currentMembersTable').DataTable({
        responsive: true,
        paging: true,
        pageLength: 5,
        lengthMenu: [[5, 10, 25, -1], [5, 10, 25, "All"]],
        searching: true,
        info: true,
        order: [[1, 'asc']], // Default sorting by Full Name
        columnDefs: [
            { orderable: true, targets: [0, 1, 2, 3] }
        ],
        language: {
            search: "",
            searchPlaceholder: "Search members...",
            zeroRecords: "No matching records found",
            info: "Showing _START_ to _END_ of _TOTAL_ members",
            infoEmpty: "No members found",
            infoFiltered: "(filtered from _MAX_ total members)"
        }
    });
    
    // Autocomplete for group_name with DN storage
    $('#group_name').autocomplete({
        source: function(request, response) {
            $.getJSON("{{ url_for('autocomplete.autocomplete_groups') }}", {
                term: request.term
            }, function(data) {
                response(data);
            });
        },
        select: function(event, ui) {
            // Set the visible value (CN)
            $('#group_name').val(ui.item.value);
            
            // Store the complete DN
            const dnMatch = ui.item.label.match(/\((.*?)\)$/);
            if (dnMatch && dnMatch[1]) {
                $('#group_dn').val(dnMatch[1]);
            }
            
            return false;
        },
        minLength: 2
    }).data('ui-autocomplete')._renderItem = function(ul, item) {
        return $('<li>')
            .append(`<div>${item.label}</div>`)
            .appendTo(ul);
    };
    
    // Autocomplete for user search when using fullName
    function initializeAutocomplete() {
        if ($('#search_type').val() === 'fullName') {
            $('#search_term').autocomplete({
                source: function(request, response) {
                    if (request.term.length < 3) {
                        response([]);
                        return;
                    }
                    
                    $.getJSON("{{ url_for('autocomplete.autocomplete_fullName') }}", {
                        term: request.term
                    }, function(data) {
                        response(data);
                    });
                },
                minLength: 3,
                delay: 300,
                select: function(event, ui) {
                    $('#search_term').val(ui.item.value);
                    return false;
                }
            }).data('ui-autocomplete')._renderItem = function(ul, item) {
                return $('<li>')
                    .append(`<div>${item.label}</div>`)
                    .appendTo(ul);
            };
        } else {
            // Unbind existing autocomplete if any
            $('#search_term').autocomplete('destroy');
        }
    }
    
    // Initialize autocomplete on page load
    initializeAutocomplete();
    
    // Re-initialize when search type changes
    $('#search_type').change(function() {
        initializeAutocomplete();
    });
    
    // Handle adding users to selection
    let selectedUsers = [];
    
    // Update the UI based on selected users
    function updateSelectedUsersUI() {
        const container = $('#selected_users_list');
        // Clear previous content except the "no users" message
        container.find('.list-group-item').remove();
        
        if (selectedUsers.length === 0) {
            $('#no_users_message').show();
            $('#confirm_add_btn').prop('disabled', true);
        } else {
            $('#no_users_message').hide();
            $('#confirm_add_btn').prop('disabled', false);
            
            // Add each selected user to the list
            selectedUsers.forEach(function(user, index) {
                container.append(`
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${user.cn}</strong> - ${user.fullName}
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-user-btn" data-index="${index}">
                            <i class="bi bi-x-circle"></i> Remove
                        </button>
                    </div>
                `);
            });
        }
        
        // Update hidden input with JSON data
        $('#selected_users_data').val(JSON.stringify(selectedUsers));
    }
    
    // Add user button click handler
    $(document).on('click', '.add-user-btn', function() {
        const dn = $(this).data('dn');
        const cn = $(this).data('cn');
        const fullName = $(this).data('fullname');
        
        // Check if user is already in selected list
        if (!selectedUsers.some(user => user.dn === dn)) {
            selectedUsers.push({
                dn: dn,
                cn: cn,
                fullName: fullName
            });
            
            updateSelectedUsersUI();
            
            // Change button to "Added" and disable it
            $(this).removeClass('btn-success').addClass('btn-secondary')
                   .html('<i class="bi bi-check-circle"></i> Added')
                   .prop('disabled', true);
        }
    });
    
    // Remove user button click handler
    $(document).on('click', '.remove-user-btn', function() {
        const index = $(this).data('index');
        const removedUser = selectedUsers[index];
        
        // Remove user from array
        selectedUsers.splice(index, 1);
        updateSelectedUsersUI();
        
        // If the user is in the search results, reset their button
        $(`.add-user-btn[data-dn="${removedUser.dn}"]`)
            .removeClass('btn-secondary').addClass('btn-success')
            .html('<i class="bi bi-plus-circle"></i> Add')
            .prop('disabled', false);
    });
    
    // Initialize UI
    updateSelectedUsersUI();
});
</script>

<style>
    /* Style for badges */
    .badge {
        font-size: 0.9rem;
        font-weight: normal;
    }
    
    /* Make table rows more compact for readability */
    .table td, .table th {
        padding: 0.5rem;
    }
    
    /* Style the selected users list */
    #selected_users_list .list-group-item {
        background-color: var(--medium-gray);
        color: var(--text-white);
        border-color: rgba(255, 255, 255, 0.125);
    }
    
    /* Fixed height for selected users container with scrolling */
    #selected_users_container {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}