{% extends "base.html" %}
{% block title %}Add Users to Group - LDAP Manager{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Add Users to Group</h1>
    
    <!-- Flash messages for any errors/warnings -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-messages mb-4">
                {% for category, message in messages %}
                    <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% else %}{{ category }}{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Group Search Section -->
    <form method="POST" action="{{ url_for('group.add_users_to_group') }}" class="card p-4 shadow mb-4">
        <input type="hidden" name="ldap_source" value="{{ ldap_source }}">
        <h4 class="mb-3">Select Group</h4>
        <div class="mb-3">
            <label for="group_name" class="form-label">Search Group:</label>
            <input type="text" class="form-control" id="group_name" name="group_name" placeholder="Start typing a group name..." value="{{ prefill_group_name }}" required>
            <!-- Hidden field to store the complete DN -->
            <input type="hidden" id="group_dn" name="group_dn" value="{{ prefill_group_dn }}">
        </div>
        <button type="submit" class="btn btn-primary">Search Group</button>
    </form>

    <!-- User Search and Selection Section (only displayed if a group is selected) -->
    {% if group_info %}
    <div class="row">
        <!-- User Search and Selected Users (stacked vertically) -->
        <div class="col-md-6">
            <!-- User Search -->
            <div class="card p-4 shadow mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Search Users to Add</h4>
                    <div>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#bulkCNModal">
                            <i class="bi bi-list-ul"></i> Bulk Add CNs
                        </button>
                        <span class="badge bg-primary ms-2">Group: {{ group_info.group_name }}</span>
                    </div>
                </div>
                <form id="userSearchForm" method="POST" action="{{ url_for('group.search_users_for_group') }}" class="mb-3">
                    <input type="hidden" name="ldap_source" value="{{ ldap_source }}">
                    <input type="hidden" name="group_name" value="{{ group_info.group_name }}">
                    <input type="hidden" name="group_dn" value="{{ group_info.group_dn }}">
                    <input type="hidden" name="selected_users_json" id="hidden_selected_users">
                    <div class="mb-3">
                        <label for="search_type" class="form-label">Search By:</label>
                        <select class="form-select" id="search_type" name="search_type" required>
                            <option value="fullName" {% if search_type == 'fullName' %}selected{% endif %}>Full Name</option>
                            <option value="cn" {% if search_type == 'cn' %}selected{% endif %}>CN (Common Name)</option>
                            <option value="workforceID" {% if search_type == 'workforceID' %}selected{% endif %}>Workforce ID</option>
                            <option value="mail" {% if search_type == 'mail' %}selected{% endif %}>Email</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="search_term" name="search_term" value="{{ search_term|default('') }}" placeholder="Enter search term..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                </form>

                {% if search_results %}
                <h5 class="mb-3">Search Results</h5>
                <div class="table-responsive">
                    <table class="table table-hover table-dark">
                        <thead>
                            <tr>
                                <th>CN</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in search_results %}
                            <tr>
                                <td>{{ user.cn }}</td>
                                <td>{{ user.fullName }}</td>
                                <td>{{ user.mail }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-success add-user-btn" 
                                            data-dn="{{ user.dn }}" 
                                            data-cn="{{ user.cn }}" 
                                            data-fullname="{{ user.fullName }}">
                                        <i class="bi bi-plus-circle"></i> Add
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>

            <!-- Selected Users (now below the search) -->
            <div class="card p-4 shadow mb-4">
                <h4 class="mb-3">Selected Users</h4>
                <div id="selected_users_container" class="mb-3">
                    <div id="selected_users_list" class="list-group">
                        <!-- Selected users will be displayed here via JavaScript -->
                        <div class="text-muted" id="no_users_message">No users selected</div>
                    </div>
                </div>
                <form id="addUsersForm" method="POST" action="{{ url_for('group.confirm_add_users') }}">
                    <input type="hidden" name="ldap_source" value="{{ ldap_source }}">
                    <input type="hidden" name="group_name" value="{{ group_info.group_name }}">
                    <input type="hidden" name="group_dn" value="{{ group_info.group_dn }}">
                    <input type="hidden" id="selected_users_data" name="selected_users" value="[]">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success" id="confirm_add_btn" disabled>
                            <i class="bi bi-check-circle"></i> Confirm Add Users
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Current Group Members (still in the right column) -->
        <div class="col-md-6">
            <div class="card p-4 shadow">
                <h4 class="mb-3">Current Group Members</h4>
                {% if group_info.users and group_info.users|length > 0 %}
                <div class="table-responsive">
                    <table id="currentMembersTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th>CN</th>
                                <th>Full Name</th>
                                <th>Title</th>
                                <th>Service</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in group_info.users %}
                            <tr 
                                role="button" 
                                onclick="window.location.href='{{ url_for('search.search_user') }}?cn={{ user.CN | urlencode }}&source={{ ldap_source }}'" 
                                style="cursor: pointer;"
                            >
                                <td>{{ user.CN | default('N/A') }}</td>
                                <td>{{ user.fullName | default('N/A') }}</td>
                                <td>{{ user.title | default('N/A') }}</td>
                                <td>{{ user.service | default('N/A') }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center">No users currently in this group.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Group Information (at the bottom) -->
    <div class="card p-4 shadow mt-4">
        <h4 class="mb-3">Group Information</h4>
        <div class="row">
            <div class="col-md-6">
                <table class="table table-dark">
                    <tbody>
                        <tr>
                            <td class="attribute-cell">Group Name</td>
                            <td>{{ group_info.group_name }}</td>
                        </tr>
                        <tr>
                            <td class="attribute-cell">Group DN</td>
                            <td><code>{{ group_info.group_dn }}</code></td>
                        </tr>
                        <tr>
                            <td class="attribute-cell">Member Count</td>
                            <td>{{ group_info.users|length }} user(s)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('group.group_users') }}?group_name={{ group_info.group_name | urlencode }}&group_dn={{ group_info.group_dn | urlencode }}&source={{ ldap_source }}" class="btn btn-info">
                        <i class="bi bi-eye"></i> View Group Details
                    </a>
                    <a href="{{ url_for('group.export_group_users_csv') }}?group_name={{ group_info.group_name | urlencode }}&group_dn={{ group_info.group_dn | urlencode }}&source={{ ldap_source }}" class="btn btn-success">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Export Group to CSV
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk CN Modal -->
    <div class="modal fade" id="bulkCNModal" tabindex="-1" aria-labelledby="bulkCNModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="bulkCNModalLabel">Bulk Add Users by CN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Paste a list of CNs/usernames, one per line. For example:</p>
                    <pre class="bg-dark text-light p-2 border">ERICRA
CHRTIE
FILWAU
IRICAA
SEDRET</pre>
                    <div class="form-group mt-3">
                        <label for="bulkCNInput" class="form-label">CNs/Usernames:</label>
                        <textarea id="bulkCNInput" class="form-control bg-dark text-light" rows="10" placeholder="Paste CNs here, one per line"></textarea>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i> Only valid CNs that exist in the directory will be added.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="processBulkCNButton">
                        <span id="processBulkCNButtonText">Process CNs</span>
                        <span class="spinner-border spinner-border-sm d-none" id="processBulkCNSpinner" role="status" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Include DataTables CSS with extensions for better styling -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.bootstrap5.min.css">

<!-- jQuery (required for DataTables and autocomplete) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery UI (for autocomplete) -->
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">

<!-- Include DataTables JS with pagination and responsive extensions -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/responsive.bootstrap5.min.js"></script>

<script>
$(document).ready(function () {
    // Global variables for user selection
    // Initialize selectedUsers from passed data if available
    let selectedUsers = {% if selected_users %}{{ selected_users|tojson }}{% else %}[]{% endif %};
    
    // Get the current LDAP source
    const ldapSource = $('input[name="ldap_source"]').val() || 'meta';
    
    // Initialize DataTables for current members table
    if ($.fn.DataTable.isDataTable('#currentMembersTable')) {
        $('#currentMembersTable').DataTable().destroy();
    }
    
    $('#currentMembersTable').DataTable({
        responsive: true,
        paging: true,
        pageLength: 5,
        lengthMenu: [[5, 10, 25, -1], [5, 10, 25, "All"]],
        searching: true,
        info: true,
        order: [[1, 'asc']], // Default sorting by Full Name
        columnDefs: [
            { orderable: true, targets: [0, 1, 2, 3] }
        ],
        language: {
            search: "",
            searchPlaceholder: "Search members...",
            zeroRecords: "No matching records found",
            info: "Showing _START_ to _END_ of _TOTAL_ members",
            infoEmpty: "No members found",
            infoFiltered: "(filtered from _MAX_ total members)"
        }
    });
    
    // Autocomplete for group_name with DN storage
    $('#group_name').autocomplete({
        source: function(request, response) {
            $.getJSON("{{ url_for('autocomplete.autocomplete_groups') }}", {
                term: request.term,
                source: ldapSource
            }, function(data) {
                response(data);
            });
        },
        select: function(event, ui) {
            // Set the visible value (CN)
            $('#group_name').val(ui.item.value);
            
            // Store the complete DN
            const dnMatch = ui.item.label.match(/\((.*?)\)$/);
            if (dnMatch && dnMatch[1]) {
                $('#group_dn').val(dnMatch[1]);
            }
            
            return false;
        },
        minLength: 2
    }).data('ui-autocomplete')._renderItem = function(ul, item) {
        return $('<li>')
            .append(`<div>${item.label}</div>`)
            .appendTo(ul);
    };
    
    // Autocomplete for user search when using fullName
    function initializeAutocomplete() {
        if ($('#search_type').val() === 'fullName') {
            $('#search_term').autocomplete({
                source: function(request, response) {
                    if (request.term.length < 3) {
                        response([]);
                        return;
                    }
                    
                    $.getJSON("{{ url_for('autocomplete.autocomplete_fullName') }}", {
                        term: request.term,
                        source: ldapSource
                    }, function(data) {
                        response(data);
                    });
                },
                minLength: 3,
                delay: 300,
                select: function(event, ui) {
                    $('#search_term').val(ui.item.value);
                    return false;
                }
            }).data('ui-autocomplete')._renderItem = function(ul, item) {
                return $('<li>')
                    .append(`<div>${item.label}</div>`)
                    .appendTo(ul);
            };
        } else {
            // Unbind existing autocomplete if any
            $('#search_term').autocomplete('destroy');
        }
    }
    
    // Initialize autocomplete on page load
    initializeAutocomplete();
    
    // Re-initialize when search type changes
    $('#search_type').change(function() {
        initializeAutocomplete();
    });
    
    // Update the UI based on selected users
    function updateSelectedUsersUI() {
        console.log("Updating UI with users:", selectedUsers);
        const container = $('#selected_users_list');
        // Clear previous content except the "no users" message
        container.find('.list-group-item').remove();
        
        if (selectedUsers.length === 0) {
            $('#no_users_message').show();
            $('#confirm_add_btn').prop('disabled', true);
        } else {
            $('#no_users_message').hide();
            $('#confirm_add_btn').prop('disabled', false);
            
            // Add each selected user to the list
            selectedUsers.forEach(function(user, index) {
                container.append(`
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${user.cn}</strong> - ${user.fullName}
                        </div>
                        <button type="button" class="btn btn-sm btn-danger remove-user-btn" data-index="${index}">
                            <i class="bi bi-x-circle"></i> Remove
                        </button>
                    </div>
                `);
            });
        }
        
        // Update hidden inputs with JSON data
        const jsonData = JSON.stringify(selectedUsers);
        $('#selected_users_data').val(jsonData);
        $('#hidden_selected_users').val(jsonData);
        console.log("Updated hidden fields with:", jsonData);
    }
    
    // Add user button click handler
    $(document).on('click', '.add-user-btn', function() {
        const dn = $(this).data('dn');
        const cn = $(this).data('cn');
        const fullName = $(this).data('fullname');
        
        // Check if user is already in selected list
        if (!selectedUsers.some(user => user.dn === dn)) {
            selectedUsers.push({
                dn: dn,
                cn: cn,
                fullName: fullName
            });
            
            updateSelectedUsersUI();
            
            // Change button to "Added" and disable it
            $(this).removeClass('btn-success').addClass('btn-secondary')
                   .html('<i class="bi bi-check-circle"></i> Added')
                   .prop('disabled', true);
        }
    });
    
    // Remove user button click handler
    $(document).on('click', '.remove-user-btn', function() {
        const index = $(this).data('index');
        const removedUser = selectedUsers[index];
        
        // Remove user from array
        selectedUsers.splice(index, 1);
        updateSelectedUsersUI();
        
        // If the user is in the search results, reset their button
        $(`.add-user-btn[data-dn="${removedUser.dn}"]`)
            .removeClass('btn-secondary').addClass('btn-success')
            .html('<i class="bi bi-plus-circle"></i> Add')
            .prop('disabled', false);
    });
    
    // Initialize UI with selected users data
    updateSelectedUsersUI();
    console.log("Initialized with users:", selectedUsers);
    
    // Add form submit event to ensure selected users are saved
    $('#userSearchForm').on('submit', function(e) {
        // Update the hidden field with current selected users
        $('#hidden_selected_users').val(JSON.stringify(selectedUsers));
    });
    
    // Handle bulk CN processing
    $('#processBulkCNButton').on('click', function() {
        // Show spinner, hide text
        $('#processBulkCNButtonText').addClass('d-none');
        $('#processBulkCNSpinner').removeClass('d-none');
        
        // Get CNs from textarea
        const cnText = $('#bulkCNInput').val().trim();
        if (!cnText) {
            alert('Please enter at least one CN.');
            // Reset button
            $('#processBulkCNButtonText').removeClass('d-none');
            $('#processBulkCNSpinner').addClass('d-none');
            return;
        }
        
        // Parse CN list (split by newline, remove empty lines)
        const cnList = cnText.split('\n')
            .map(cn => cn.trim())
            .filter(cn => cn);
        
        if (cnList.length === 0) {
            alert('No valid CNs found.');
            // Reset button
            $('#processBulkCNButtonText').removeClass('d-none');
            $('#processBulkCNSpinner').addClass('d-none');
            return;
        }
        
        // Make AJAX request to validate and get user details
        $.ajax({
            url: "{{ url_for('group.validate_bulk_cns') }}",
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                cn_list: cnList,
                group_dn: "{{ group_info.group_dn if group_info else '' }}",
                ldap_source: ldapSource
            }),
            success: function(response) {
                // Process valid users
                if (response.valid_users && response.valid_users.length > 0) {
                    // Add each valid user to selected users
                    response.valid_users.forEach(user => {
                        // Check if user is already in selected list
                        if (!selectedUsers.some(u => u.dn === user.dn)) {
                            selectedUsers.push({
                                dn: user.dn,
                                cn: user.cn,
                                fullName: user.fullName
                            });
                        }
                    });
                    
                    // Update UI
                    updateSelectedUsersUI();
                    
                    // Show success message
                    alert(`Added ${response.valid_users.length} users. ${response.invalid_users.length} CNs were invalid or already in the group.`);
                } else {
                    alert('No valid users found. Make sure the CNs exist and are not already in the group.');
                }
                
                // Close modal
                $('#bulkCNModal').modal('hide');
            },
            error: function(xhr, status, error) {
                console.error("Error validating CNs:", error);
                alert('Error processing CNs. Please try again.');
            },
            complete: function() {
                // Reset button
                $('#processBulkCNButtonText').removeClass('d-none');
                $('#processBulkCNSpinner').addClass('d-none');
                
                // Clear textarea
                $('#bulkCNInput').val('');
            }
        });
    });
});
</script>

<style>
    /* Style for badges */
    .badge {
        font-size: 0.9rem;
        font-weight: normal;
    }
    
    .badge.bg-primary {
        background-color: #3498db !important;
        padding: 8px 12px;
        font-size: 0.85rem;
    }
    
    /* Make table rows more compact for readability */
    .table td, .table th {
        padding: 0.5rem;
    }
    
    /* Style the selected users list */
    #selected_users_list .list-group-item {
        background-color: var(--medium-gray);
        color: var(--text-white);
        border-color: rgba(255, 255, 255, 0.125);
    }
    
    /* Fixed height for selected users container with scrolling */
    #selected_users_container {
        max-height: 300px;
        overflow-y: auto;
    }
    
    /* Style for attribute cells in tables */
    table.table-dark tbody tr td.attribute-cell {
        background-color: #1a2533;
        color: #23c7bf !important;
        font-weight: 600 !important;
        font-size: 1.05rem !important;
        padding: 12px 15px;
        border-right: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Style for code elements */
    code {
        background-color: #192734;
        color: #e2e2e2;
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.9em;
        word-break: break-all;
    }
</style>
{% endblock %}