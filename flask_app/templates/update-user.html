{% extends "base.html" %}

{% block title %}Update User - LDAP Manager{% endblock %}
{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
<!-- jQuery UI CSS -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Search Form -->
    <div class="card shadow mb-3">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">Search Active User</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('userupdate.search_user') }}" class="mb-3">
                <input type="hidden" name="ldap_source" value="{{ ldap_source }}">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label for="search_type" class="form-label">Search By:</label>
                        <select class="form-select" id="search_type" name="search_type" required>
                            <option value="fullName" {% if search_type == 'fullName' %}selected{% endif %}>Full Name</option>
                            <option value="cn" {% if search_type == 'cn' %}selected{% endif %}>CN (Common Name)</option>
                            <option value="workforceID" {% if search_type == 'workforceID' %}selected{% endif %}>Workforce ID</option>
                            <option value="mail" {% if search_type == 'mail' %}selected{% endif %}>Email</option>
                        </select>
                    </div>
                    <div class="col-md-7">
                        <label for="search_term" class="form-label">Search Term:</label>
                        <input type="text" class="form-control" id="search_term" name="search_term" value="{{ search_term|default('') }}" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </form>

            {% if search_results %}
                <div class="table-responsive mt-2">
                    <table class="table table-hover table-dark">
                        <thead>
                            <tr>
                                <th>CN</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in search_results %}
                            <tr>
                                <td>{{ user.cn }}</td>
                                <td>{{ user.fullName }}</td>
                                <td>{{ user.mail }}</td>
                                <td>
                                    <a href="{{ url_for('userupdate.select_user') }}?user_dn={{ user.dn }}&source={{ ldap_source }}" class="btn btn-sm btn-primary">
                                        <i class="bi bi-pencil"></i> Select
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>
    </div>

    {% if selected_user %}
    <!-- User Profile and Tabs -->
    <form id="userUpdateForm" method="POST" action="{{ url_for('userupdate.update_user') }}">
        <input type="hidden" name="user_dn" value="{{ selected_user.dn }}">
        <input type="hidden" name="ldap_source" value="{{ ldap_source }}">
        
        <!-- User Header -->
        <div class="user-header mb-4">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="user-avatar">
                        {{ selected_user.CN[0] | upper }}
                    </div>
                </div>
                <div class="col">
                    <h3 class="text-white mb-1">{{ selected_user.fullName }}</h3>
                    <div class="text-light">{{ selected_user.CN }} <span class="badge bg-info">{{ selected_user.favvEmployeeType }}</span></div>
                    <div class="text-light">{{ selected_user.mail }}</div>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                    <a href="{{ url_for('search.search_user') }}?cn={{ selected_user.CN }}&source={{ ldap_source }}" class="btn btn-secondary ms-2">
                        <i class="bi bi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="userTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">
                    <i class="bi bi-person"></i> General
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups" type="button" role="tab" aria-controls="groups" aria-selected="false">
                    <i class="bi bi-people"></i> Groups
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button" role="tab" aria-controls="roles" aria-selected="false">
                    <i class="bi bi-people"></i> RBPM Roles
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                    <i class="bi bi-shield-lock"></i> Security
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="false">
                    <i class="bi bi-key"></i> Account
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="restrictions-tab" data-bs-toggle="tab" data-bs-target="#restrictions" type="button" role="tab" aria-controls="restrictions" aria-selected="false">
                    <i class="bi bi-lock"></i> Restrictions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="container-tab" data-bs-toggle="tab" data-bs-target="#container" type="button" role="tab" aria-controls="container" aria-selected="false">
                    <i class="bi bi-folder2"></i> Container
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="protime-tab" data-bs-toggle="tab" data-bs-target="#protime" type="button" role="tab" aria-controls="protime" aria-selected="false">
                    <i class="bi bi-clock"></i> Protime
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="misc-tab" data-bs-toggle="tab" data-bs-target="#misc" type="button" role="tab" aria-controls="miscellaneous" aria-selected="false">
                    <i class="bi bi-folder1"></i> Miscellaneous
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="DirXML-tab" data-bs-toggle="tab" data-bs-target="#DirXML" type="button" role="tab" aria-controls="DirXML" aria-selected="false">
                    <i class="bi bi-folder1"></i> Dirxml Associations
                </button>
                <!-- <div class="tab-pane fade" id="DirXML" role="tabpanel" aria-labelledby="DirXML-tab"></div> -->
            </li>
        </ul>
        
        <!-- Tabs Content -->
        <div class="tab-content" id="userTabsContent">
            <!-- General Tab -->
            <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">User Information</h6>
                            <div class="row mb-3">
                                <label for="givenName" class="col-md-4 col-form-label">Given Name:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="givenName" name="givenName" value="{{ selected_user.givenName }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="surname" class="col-md-4 col-form-label">Surname:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="surname" name="surname" value="{{ selected_user.sn }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="email" class="col-md-4 col-form-label">Email Address:</label>
                                <div class="col-md-8">
                                    <input type="email" class="form-control" id="email" name="mail" value="{{ selected_user.mail }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="title" class="col-md-4 col-form-label">Title:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="title" name="title" value="{{ selected_user.title }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="department" class="col-md-4 col-form-label">Telephone Number:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="telephoneNumber" name="telephoneNumber" value="{{ selected_user.telephoneNumber }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="department" class="col-md-4 col-form-label">Mobile phone Number:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="mobileNumber" name="mobileNumber" value="{{ selected_user.mobile }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="workforceID" class="col-md-4 col-form-label">StamNr/N° matricule:</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="workforceID" name="workforceID" value="{{ selected_user.workforceID }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Organization</h6>
                            <div class="row mb-3">
                                <label for="ou" class="col-md-4 col-form-label">Service (OU):</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="ou" name="ou" value="{{ selected_user.service }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="hierarchical_manager" class="col-md-4 col-form-label">Chef Hiérarchique:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="hierarchical_manager" name="hierarchical_manager" value="{{ selected_user.ChefHierarchique }}" placeholder="Start typing to search for managers...">
                                    <input type="hidden" id="manager_dn" name="manager_dn" value="{{ selected_user.FavvHierarMgrDN }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="FavvFuncMgrDn" class="col-md-4 col-form-label">Chef Fonctionnel:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="chefFunc" name="chefFunc" value="{{ selected_user.ChefFonctionnel }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="employeeType" class="col-md-4 col-form-label">Employee Type:</label>
                                <div class="col-md-6">
                                    <select id="employeeType" name="FavvEmployeeType" class="form-select">
                                        <option value="">-- Select an employee type --</option>
                                        <option value="EXTERN" {% if selected_user.FavvEmployeeType == 'EXTERN' %}selected{% endif %}>EXTERN</option>
                                        <option value="CWK - DMO" {% if selected_user.FavvEmployeeType == 'CWK - DMO' %}selected{% endif %}>CWK - DMO</option>
                                        <option value="EMP - Employee" {% if selected_user.FavvEmployeeType == 'EMP - Employee' %}selected{% endif %}>EMP - Employee</option>
                                        <option value="EMP - Andere" {% if selected_user.FavvEmployeeType == 'EMP - Andere' %}selected{% endif %}>EMP - Andere</option>
                                        <option value="EMP - STAG" {% if selected_user.FavvEmployeeType == 'EMP - STAG' %}selected{% endif %}>EMP - STAG</option>
                                        {% if selected_user.FavvEmployeeType and selected_user.FavvEmployeeType not in ['EXTERN', 'CWK - DMO', 'EMP - Employee', 'EMP - Andere', 'EMP - STAG'] %}
                                        <option value="{{ selected_user.FavvEmployeeType }}" selected>{{ selected_user.FavvEmployeeType }}</option>
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            
                            <h6 class="tab-section-header">Workplace</h6>
                            <div class="row mb-3">
                                <label for="FavvGem" class="col-md-4 col-form-label">Commune/Gemeente:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="favvgem" name="favvgem" value="{{ selected_user.Commune }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="location" class="col-md-4 col-form-label">Location:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="location" name="location" value="{{ selected_user.location }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="FavvGbw" class="col-md-4 col-form-label">Bâtiment/Gebouw:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="favvgbw" name="favvgbw" value="{{ selected_user.Batiment }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="FavvBuildFloor" class="col-md-4 col-form-label">Floor:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="buildFloor" name="buildFloor" value="{{ selected_user.FavvBuildFloor }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="roomNumber" class="col-md-4 col-form-label">Room Number:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="roonNumber" name="roomNumber" value="{{ selected_user.roomNumber }}" readonly>
                                </div>
                            </div>
                            
                            
                           
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Groups Tab -->
            <div class="tab-pane fade" id="groups" role="tabpanel" aria-labelledby="groups-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Current Group Memberships</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="group-filter" class="form-control" placeholder="Filter groups...">
                                <button id="sort-groups" class="btn btn-outline-secondary">
                                    <i class="bi bi-sort-alpha-down"></i>
                                </button>
                            </div>
                            <div class="card bg-dark p-3" style="max-height: 400px; overflow-y: auto;">
                                <div id="current_groups">
                                    {% if selected_user.groupMembership %}
                                        {% for group in selected_user.groupMembership %}
                                            <a href="{{ url_for('group.group_users') }}?group_name={{ group.cn | urlencode }}&group_dn={{ group.dn | urlencode }}&source={{ ldap_source }}" 
                                               class="badge bg-info me-2 mb-2 p-2 group-badge text-decoration-none" 
                                               style="cursor: pointer;" 
                                               title="View members of {{ group.cn }}">
                                                {{ group.cn }}
                                                <i class="bi bi-people-fill ms-1"></i>
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">No group memberships</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Add to Groups</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="group_name" class="form-control" placeholder="Start typing a group name...">
                                <button type="button" id="add_group_btn" class="btn btn-outline-success">Add</button>
                            </div>
                            <div class="card bg-dark p-3" style="min-height: 100px;">
                                <div id="groups_to_add">
                                    <!-- Groups to add will be displayed here -->
                                </div>
                            </div>
                            <input type="hidden" id="groups_to_add_data" name="groups_to_add" value="[]">
                        </div>
                        
                        <div class="tab-section mt-4">
                            <h6 class="tab-section-header">Remove from Groups</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="group_remove" class="form-control" placeholder="Start typing a group name...">
                                <button type="button" id="remove_group_btn" class="btn btn-outline-danger">Remove</button>
                            </div>
                            <div class="card bg-dark p-3" style="min-height: 100px;">
                                <div id="groups_to_remove">
                                    <!-- Groups to remove will be displayed here -->
                                </div>
                            </div>
                            <input type="hidden" id="groups_to_remove_data" name="groups_to_remove" value="[]">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RBPM Roles Tab -->
            <div class="tab-pane fade" id="roles" role="tabpanel" aria-labelledby="roles-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section mt-4">
                            <h6 class="tab-section-header">Current Role Memberships</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="role-filter" class="form-control" placeholder="Filter roles...">
                                <button id="sort-roles" class="btn btn-outline-secondary">
                                    <i class="bi bi-sort-alpha-down"></i>
                                </button>
                            </div>
                            <div class="card bg-dark p-3" style="max-height: 400px; overflow-y: auto;">
                                <div id="current_roles">
                                    {% if selected_user.nrfMemberOf %}
                                        {% for role in selected_user.nrfMemberOf %}
                                            <!-- <div class="badge bg-secondary me-2 mb-2 p-2 role-badge">
                                                {{ role.cn }} ({{ role.category }})
                                            </div> -->
                                            <a href="{{ url_for('role.role_users') }}?role_cn={{ role.cn | urlencode }}&role_dn={{ role.dn | urlencode }}&source={{ ldap_source }}" 
                                               class="badge bg-info me-2 mb-2 p-2 group-badge text-decoration-none" 
                                               style="cursor: pointer;" 
                                               title="View members of {{ role.cn }}">
                                                {{ role.cn }} ({{ role.category }})
                                                <i class="bi bi-people-fill ms-1"></i>
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-muted">No role memberships</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Add to Role</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="group_name" class="form-control" placeholder="Start typing a group name...">
                                <button type="button" id="add_group_btn" class="btn btn-outline-success">Add</button>
                            </div>
                            <div class="card bg-dark p-3" style="min-height: 100px;">
                                <div id="groups_to_add">
                                    <!-- Groups to add will be displayed here -->
                                </div>
                            </div>
                            <input type="hidden" id="groups_to_add_data" name="groups_to_add" value="[]">
                        </div>
                        
                        <div class="tab-section mt-4">
                            <h6 class="tab-section-header">Remove from Role</h6>
                            <div class="input-group mb-3">
                                <input type="text" id="group_remove" class="form-control" placeholder="Start typing a group name...">
                                <button type="button" id="remove_group_btn" class="btn btn-outline-danger">Remove</button>
                            </div>
                            <div class="card bg-dark p-3" style="min-height: 100px;">
                                <div id="groups_to_remove">
                                    <!-- Groups to remove will be displayed here -->
                                </div>
                            </div>
                            <input type="hidden" id="groups_to_remove_data" name="groups_to_remove" value="[]">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Security Settings</h6>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="loginDisabled" name="loginDisabled" value="true" 
                                        {% if selected_user.loginDisabled == 'YES' %}checked{% endif %}>
                                    <label class="form-check-label" for="loginDisabled">
                                        Disable Login
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requireUniquePassword" name="requireUniquePassword">
                                    <label class="form-check-label" for="requireUniquePassword">
                                        Require Unique Passwords
                                    </label>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="passwordExpiration" class="col-md-6 col-form-label">Password Expiration:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="passwordExpiration" name="passwordExpiration" value="{{ selected_user.passwordExpirationTime }}" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="lastLogin" class="col-md-6 col-form-label">Last Login:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="lastLogin" name="lastLogin" value="{{ selected_user.loginTime }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Password Management</h6>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="reset_password" name="reset_password" value="true">
                                    <label class="form-check-label" for="reset_password">
                                        Reset Password to Default
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="expire_password" name="expire_password" value="true">
                                    <label class="form-check-label" for="expire_password">
                                        Force Password Change at Next Login
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allowUserChangePassword" name="allowUserChangePassword" checked>
                                    <label class="form-check-label" for="allowUserChangePassword">
                                        Allow User to Change Password
                                    </label>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="minPasswordLength" class="col-md-6 col-form-label">Minimum Password Length:</label>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="minPasswordLength" name="minPasswordLength" value="8">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="graceLogins" class="col-md-6 col-form-label">Grace Logins:</label>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="graceLogins" name="graceLogins" value="5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Account Tab -->
            <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Account Information</h6>
                            
                            <div class="table-responsive">
                                <table class="table table-dark">
                                    <tbody>
                                        <tr>
                                            <td width="30%">Common Name (CN):</td>
                                            <td>{{ selected_user.CN }}</td>
                                        </tr>
                                        <tr>
                                            <td>Distinguished Name (DN):</td>
                                            <td><code>{{ selected_user.dn }}</code></td>
                                        </tr>
                                        <tr>
                                            <td>Created On:</td>
                                            <td>[Creation Date Not Available]</td>
                                        </tr>
                                        <tr>
                                            <td>Modified On:</td>
                                            <td>[Last Modified Date Not Available]</td>
                                        </tr>
                                        <tr>
                                            <td>Last Login:</td>
                                            <td>{{ selected_user.loginTime }}</td>
                                        </tr>
                                        <tr>
                                            <td>Account Status:</td>
                                            <td>
                                                {% if selected_user.loginDisabled == 'YES' %}
                                                <span class="badge bg-danger">Disabled</span>
                                                {% else %}
                                                <span class="badge bg-success">Active</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>Password Expiration:</td>
                                            <td>{{ selected_user.passwordExpirationTime }}</td>
                                        </tr>
                                        {% if selected_user.FavvNatNr %}
                                        <tr>
                                            <td>National Register Number:</td>
                                            <td>{{ selected_user.FavvNatNr }}</td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Restrictions Tab -->
            <div class="tab-pane fade" id="restrictions" role="tabpanel" aria-labelledby="restrictions-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Login Restrictions</h6>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="limitConcurrentConnections" name="limitConcurrentConnections">
                                    <label class="form-check-label" for="limitConcurrentConnections">
                                        Limit Concurrent Connections
                                    </label>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="maxConnections" class="col-md-6 col-form-label">Maximum Connections:</label>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="maxConnections" name="maxConnections" value="2" disabled>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="limitStationRestrictions" name="limitStationRestrictions">
                                    <label class="form-check-label" for="limitStationRestrictions">
                                        Limit Station Restrictions
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="allowedStations" class="form-label">Allowed Stations:</label>
                                <textarea class="form-control" id="allowedStations" name="allowedStations" rows="3" disabled></textarea>
                                <small class="form-text text-muted">Enter one station per line</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Time Restrictions</h6>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableTimeRestrictions" name="enableTimeRestrictions">
                                    <label class="form-check-label" for="enableTimeRestrictions">
                                        Enable Time Restrictions
                                    </label>
                                </div>
                            </div>
                            
                            <div class="card bg-dark p-3 mb-3">
                                <div class="time-restriction-grid" style="pointer-events: none; opacity: 0.6;">
                                    <!-- This would be a grid of checkboxes for time slots -->
                                    <p class="text-center mb-0">Time restriction grid not implemented</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                                        Monday-Friday 8am-6pm
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                                        All Hours
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                                        No Access
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Container Tab -->
            <div class="tab-pane fade" id="container" role="tabpanel" aria-labelledby="container-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Container Management</h6>
                            
                            <div class="mb-3">
                                <label for="current_container" class="form-label">Current Container:</label>
                                <input type="text" class="form-control" id="current_container" value="{{ selected_user.dn.split(',', 1)[1] }}" readonly>
                            </div>
                            
                            <div class="mb-3">
                                <label for="target_container" class="form-label">Move to Container:</label>
                                <select id="target_container" name="target_container" class="form-select">
                                    <option value="">-- Don't move user --</option>
                                    <option value="ou=users,ou=sync,o=COPY">Active Users</option>
                                    <option value="ou=out,ou=sync,o=COPY">Inactive Users (Archive)</option>
                                    <option value="ou=to-process,ou=sync,o=COPY">To-Process</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="change_reason" class="form-label">Reason for Changes:</label>
                                <textarea id="change_reason" name="change_reason" class="form-control" rows="4" 
                                        placeholder="Describe why these changes are being made"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Container Information</h6>
                            
                            <div class="mb-3">
                                <p class="text-muted mb-2">A container represents a location in the LDAP directory tree. Moving a user to a different container can change their access rights and visibility.</p>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <strong>Information:</strong> Moving a user will change their Distinguished Name (DN).
                                </div>
                                
                                <div class="card bg-dark p-3">
                                    <div class="mb-2"><strong>Common Containers:</strong></div>
                                    <ul class="mb-0">
                                        <li><strong>Active Users</strong>: Normal active user accounts</li>
                                        <li><strong>Inactive Users</strong>: Archived accounts</li>
                                        <li><strong>To-Process</strong>: New accounts awaiting configuration</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Protime Tab -->
            <div class="tab-pane fade" id="protime" role="tabpanel" aria-labelledby="protime-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Protime Settings</h6>
                            <div class="row mb-3">
                                <label for="ProtimeBadgeNr" class="col-md-6 col-form-label">Protime Badge Nr:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="protimeBadgeNr" name="protimeBadgeNr" value="{{ selected_user.FavvPTBadgeNr }}">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <label for="ProtimePinCode" class="col-md-6 col-form-label">Protime Pincode:</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="protimepincode" name="protimepincode" value="{{ selected_user.FavvPTPinCode }}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Miscellaneous Tab -->
            <div class="tab-pane fade" id="misc" role="tabpanel" aria-labelledby="misc-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="tab-section">
                            <h6 class="tab-section-header">Miscellaneous Settings</h6>
                            <div class="row mb-3">
                                <label for="FavvAccountStatus" class="col-md-6 col-form-label">Account Status (FavvAccountStatus):</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="accountStatus" name="accountStatus" value="{{ selected_user.FavvAccountStatus }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="FavvAffecStat" class="col-md-6 col-form-label">Affectation Status (FavvAffecStat):</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="affectStat" name="affectStat" value="{{ selected_user.Affectation }}" readonly>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label for="FavvInDatum" class="col-md-6 col-form-label">Entry date (FavvInDatum):</label>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="indatum" name="indatum" value="{{ selected_user.FavvinDatum }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DirXML associations Tab -->
            <div class="tab-pane fade" id="DirXML" role="tabpanel" aria-labelledby="DirXML-tab">
                <div class="row">
                    <div class="col-md-12">
                        <div class="tab-section">
                            <h6 class="tab-section-header">DirXML - IDM Associations</h6>
                            <div class="card p-3 bg-dark">
                                <div id="dirxml">
                                    {% if selected_user.DirXMLAssociations %}
                                        <div class="table-responsive">
                                            <table class="table table-dark table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Association</th>
                                                        <th width="80" class="text-center">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for association in selected_user.DirXMLAssociations %}
                                                    <tr>
                                                        <td class="text-break">{{ association }}</td>
                                                        <td class="text-center">
                                                            <button type="button" class="btn btn-danger btn-sm delete-association-btn" 
                                                                    data-association-index="{{ loop.index0 }}" 
                                                                    data-association-value="{{ association }}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        <!-- Hidden input to track associations to be deleted -->
                                        <input type="hidden" id="associations_to_delete" name="associations_to_delete" value="[]">
                                    {% else %}
                                        <div class="text-muted">No DirXML Associations found.</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Add a note about deletion -->
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle"></i> 
                                Click the delete button to mark an association for removal. Changes will be applied when you save the user.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </form>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- URLs for JavaScript -->
<script>
    // Passing URL values and user data to JavaScript
    window.autocompleteFullNameUrl = "{{ url_for('autocomplete.autocomplete_fullName') }}";
    window.autocompleteManagersUrl = "{{ url_for('autocomplete.autocomplete_managers') }}";
    window.autocompleteServicesUrl = "{{ url_for('autocomplete.autocomplete_services') }}";
    window.autocompleteGroupsUrl = "{{ url_for('autocomplete.autocomplete_groups') }}";
    
    // User's group memberships for autocomplete
    {% if selected_user and selected_user.groupMembership %}
    window.userGroups = [
        {% for group in selected_user.groupMembership %}
        {
            label: "{{ group.cn }}",
            value: "{{ group.cn }}",
            dn: "{{ group.dn }}"
        },
        {% endfor %}
    ];
    {% else %}
    window.userGroups = [];
    {% endif %}
</script>
<script src="{{ url_for('static', filename='js/update_user.js') }}"></script>
{% endblock %}