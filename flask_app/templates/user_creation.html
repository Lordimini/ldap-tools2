{% extends "base.html" %}

{% block title %}
    Create User - LDAP Manager
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Create User Account</h1>
    
    <!-- Flash messages for any errors/warnings -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="alert-messages mb-4">
                {% for category, message in messages %}
                    <div class="alert alert-{% if category == 'error' %}danger{% elif category == 'success' %}success{% else %}{{ category }}{% endif %} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Form to create a new user -->
    <form method="POST" class="card p-4 shadow" id="userCreationForm">
        {{ form.hidden_tag() }}
        
        <!-- Dropdown for User Type -->
        <div class="mb-3">
            <label for="user_type" class="form-label">User Type:</label>
            <select id="user_type" name="user_type" class="form-select">
                {% for choice in form.user_type.choices %}
                    <option value="{{ choice[0] }}" {% if form_data and form_data.user_type == choice[0] %}selected{% endif %}>{{ choice[1] }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Given Name -->
        <div class="mb-3">
            <label for="givenName" class="form-label">Given Name:</label>
            <input type="text" id="givenName" name="givenName" class="form-control" value="{{ form_data.givenName if form_data else '' }}" required>
        </div>

        <!-- Surname -->
        <div class="mb-3">
            <label for="sn" class="form-label">Surname:</label>
            <input type="text" id="sn" name="sn" class="form-control" value="{{ form_data.sn if form_data else '' }}" required>
        </div>

        <!-- Email (Now Required) -->
        <div class="mb-3">
            <label for="email" class="form-label">Email:</label>
            <div class="input-group">
                <input type="email" id="email" name="email" class="form-control" value="{{ form_data.email if form_data else '' }}" required>
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#emailWarningModal">
                    <i class="fas fa-exclamation-triangle"></i> Override
                </button>
            </div>
            <input type="hidden" id="email_override" name="email_override" value="false">
        </div>
        
        <!-- Hierarchical Manager (for STAG users) -->
        <div id="manager_container" class="mb-3" style="display: none;">
            <label for="manager" class="form-label">Hierarchical Manager:</label>
            <div class="input-group">
                <input type="text" id="manager" name="manager" class="form-control" value="{{ form_data.manager if form_data else '' }}" placeholder="Start typing to search for managers...">
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#managerWarningModal">
                    <i class="fas fa-exclamation-triangle"></i> Override
                </button>
            </div>
            <small class="form-text text-muted">Only managers with FavvDienstHoofd=YES are valid.</small>
            <input type="hidden" id="manager_override" name="manager_override" value="false">
        </div>

        <!-- OCI Specific Field (shown conditionally) -->
        <div id="favvNatNr_container" class="mb-3" style="display: none;">
            <label for="favvNatNr" class="form-label">National Register Number:</label>
            <div class="input-group">
                <input type="text" id="favvNatNr" name="favvNatNr" class="form-control" placeholder="Enter National Register Number" value="{{ form_data.favvNatNr if form_data else '' }}">
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#favvNatNrWarningModal">
                    <i class="fas fa-exclamation-triangle"></i> Override
                </button>
            </div>
            <small class="form-text text-muted">Format will be automatically normalized to remove spaces and hyphens.</small>
            <input type="hidden" id="favvNatNr_override" name="favvNatNr_override" value="false">
        </div>

        <!-- Submit button -->
        <button type="submit" class="btn btn-primary">Create User</button>
    </form>

    <!-- Email Warning Modal -->
    <div class="modal fade" id="emailWarningModal" tabindex="-1" aria-labelledby="emailWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="emailWarningModalLabel">Warning!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Attention, à vos risques et périls!</strong></p>
                    <p>Creating a user without an email address is not recommended. Are you sure you want to continue?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmEmailOverride">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manager Warning Modal -->
    <div class="modal fade" id="managerWarningModal" tabindex="-1" aria-labelledby="managerWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="managerWarningModalLabel">Warning!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Attention, à vos risques et périls!</strong></p>
                    <p>Creating a trainee without a hierarchical manager is not recommended. Are you sure you want to continue?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmManagerOverride">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FavvNatNr Warning Modal -->
    <div class="modal fade" id="favvNatNrWarningModal" tabindex="-1" aria-labelledby="favvNatNrWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title" id="favvNatNrWarningModalLabel">Warning!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Attention, à vos risques et périls!</strong></p>
                    <p>Creating an OCI user without a National Register Number is not recommended. Are you sure you want to continue?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmFavvNatNrOverride">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Show/hide FavvNatNr field based on user type selection
            const userTypeSelect = document.getElementById('user_type');
            const favvNatNrContainer = document.getElementById('favvNatNr_container');
            const managerContainer = document.getElementById('manager_container');
            
            // Function to toggle visibility of fields based on user type
            function toggleFields() {
                // OCI types
                if (userTypeSelect.value === 'BOODOCI' || userTypeSelect.value === 'OCI') {
                    favvNatNrContainer.style.display = 'block';
                } else {
                    favvNatNrContainer.style.display = 'none';
                }
                
                // STAG type (trainee)
                if (userTypeSelect.value === 'STAG') {
                    managerContainer.style.display = 'block';
                } else {
                    managerContainer.style.display = 'none';
                }
            }
            
            // Initial check
            toggleFields();
            
            // Listen for changes
            userTypeSelect.addEventListener('change', toggleFields);
            
            // FavvNatNr normalization
            const favvNatNrInput = document.getElementById('favvNatNr');
            favvNatNrInput.addEventListener('input', function(e) {
                // Remove all non-digit characters
                const normalized = e.target.value.replace(/[^0-9]/g, '');
                
                // Update input value with normalized string
                e.target.value = normalized;
            });
            
            // Handle FavvNatNr Override
            document.getElementById('confirmFavvNatNrOverride').addEventListener('click', function() {
                document.getElementById('favvNatNr_override').value = 'true';
                document.getElementById('favvNatNr').required = false;
                
                // Close the modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('favvNatNrWarningModal'));
                modal.hide();
            });
            
            // Handle Email Override
            document.getElementById('confirmEmailOverride').addEventListener('click', function() {
                document.getElementById('email_override').value = 'true';
                document.getElementById('email').required = false;
                
                // Close the modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('emailWarningModal'));
                modal.hide();
            });
            
            // Handle Manager Override
            document.getElementById('confirmManagerOverride').addEventListener('click', function() {
                document.getElementById('manager_override').value = 'true';
                document.getElementById('manager').required = false;
                
                // Close the modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('managerWarningModal'));
                modal.hide();
            });
            
            // Manager Autocomplete
            $('#manager').autocomplete({
                source: function(request, response) {
                    $.getJSON("{{ url_for('autocomplete.autocomplete_managers') }}", {
                        term: request.term
                    }, function(data) {
                        response(data);
                    });
                },
                select: function(event, ui) {
                    $('#manager').val(ui.item.value);
                    return false;
                },
                minLength: 2
            }).data('ui-autocomplete')._renderItem = function(ul, item) {
                return $('<li>')
                    .append(`<div>${item.label}</div>`)
                    .appendTo(ul);
            };
            
            // Form submission handling
            document.getElementById('userCreationForm').addEventListener('submit', function(event) {
                // Check if form is valid
                if (!this.checkValidity()) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                // Check if email is required and empty
                const emailField = document.getElementById('email');
                const emailOverride = document.getElementById('email_override').value === 'true';
                
                if (!emailField.value && !emailOverride) {
                    event.preventDefault();
                    alert('Email address is required. Use the override button if you want to proceed without an email.');
                }
                
                // Check if FavvNatNr is required and empty
                if (favvNatNrContainer.style.display !== 'none') {
                    const favvNatNrField = document.getElementById('favvNatNr');
                    const favvNatNrOverride = document.getElementById('favvNatNr_override').value === 'true';
                    
                    if (!favvNatNrField.value && !favvNatNrOverride) {
                        event.preventDefault();
                        alert('National Register Number is required for this user type. Use the override button if you want to proceed without it.');
                    }
                }
                
                // Check if Manager is required and empty
                if (managerContainer.style.display !== 'none') {
                    const managerField = document.getElementById('manager');
                    const managerOverride = document.getElementById('manager_override').value === 'true';
                    
                    if (!managerField.value && !managerOverride) {
                        event.preventDefault();
                        alert('Hierarchical Manager is required for trainees. Use the override button if you want to proceed without it.');
                    }
                }
            });
        });
    </script>
</div>
{% endblock %}